<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>使用gdb调试多线程程序 | Hack Note</title>
<link href="https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
<link href="/assets/css/code.css" rel="stylesheet" type="text/css">
<link href="/assets/css/highlight.css" rel="stylesheet" type="text/css">
<link href="/assets/css/colorbox.css" rel="stylesheet" type="text/css">
<link href="/assets/css/cerulean.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" href="/rss.xml">
<link rel="canonical" href="http://samsonwang.me/posts/debug-with-gdb-on-multi-thread-programs/">
<link rel="icon" href="/favicon.ico" sizes="64x64">
<!--[if lt IE 9]><script src="https://html5shim.googlecode.com/svn/trunk/html5.js"></script><![endif]--><meta name="author" content="Samson Wang">
<link rel="prev" href="/posts/gdb-ignore-received-signal/" title="在gdb调试时忽略系统信号（signal）" type="text/html">
<link rel="next" href="/posts/linux-command-examples-ipcs/" title="Linux常用命令行指令 - ipcs" type="text/html">
<meta property="og:site_name" content="Hack Note">
<meta property="og:title" content="使用gdb调试多线程程序">
<meta property="og:url" content="http://samsonwang.me/posts/debug-with-gdb-on-multi-thread-programs/">
<meta property="og:description" content="查看当前线程信息


将进程中的各个线程信息显示出来

(gdb) info threads



切换到指定进程

(gdb) thread tid



向指定的线程发送自定的指令

(gdb) thread apply tid/all args


常用的指定是查看所有线程的调用堆栈 thread apply all bt ，这个指令与 pstack 命令有些相似。



gdb默认会自动捕">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2018-04-20T21:25:09+08:00">
<meta property="article:tag" content="gdb">
<meta property="article:tag" content="linux">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->
<nav class="navbar navbar-inverse navbar-fixed-top"><div class="container">
  <!-- This keeps the margins nice -->

    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="http://samsonwang.me/">

        <span id="blog-title">Hack Note</span>
      </a>
    </div>

    <!-- /.navbar-header -->
    <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
      <ul class="nav navbar-nav">
<li>
<a href="/archive/">Archives</a>
                </li>
<li>
<a href="/tags/">Tags</a>
                </li>
<li>
<a href="/listings/">Listings</a>
                </li>
<li>
<a href="/galleries/">Galleries</a>
                </li>
<li>
<a href="/rss.xml">RSS Feed</a>

        
      </li>
</ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!-- /.navbar-collapse -->
  </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
  <div class="body-content">
    <!--Body content-->
    <div class="row">

      <div class="col-sm-9">
        
        
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="/posts/debug-with-gdb-on-multi-thread-programs/" class="u-url">使用gdb调试多线程程序</a></h1>

      <div class="metadata">
        <div class="author">
            Samson Wang
        </div>
        <div class="date">
          <a href="/posts/debug-with-gdb-on-multi-thread-programs/" rel="bookmark">
            <time class="published dt-published" datetime="2018-04-20T21:25:09+08:00" itemprop="datePublished" title="2018-04-20 21:25">2018-04-20 21:25
            </time></a>
        </div>
        
        
    <div class="source">
      <p class="sourceline"><a href="/posts/debug-with-gdb-on-multi-thread-programs/index.org" class="sourcelink">Source</a></p>
    </div>

        
          <div class="link">
            <a href="https://sourceware.org/gdb/onlinedocs/gdb/Threads.html">Original site</a>
          </div>
          
      </div>
      

  </header><ul itemprop="keywords" class="tags">
    Tags : 
        <li><a class="tag p-category" href="/tags/gdb/" rel="tag">gdb</a></li>
        <li><a class="tag p-category" href="/tags/linux/" rel="tag">linux</a></li>
    </ul>
<div class="e-content entry-content" itemprop="articleBody text">
    <div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">查看当前线程信息</h2>
<div class="outline-text-2" id="text-1">
<p>
<b>将进程中的各个线程信息显示出来</b><br></p>
<div class="highlight"><pre><span></span>(gdb) info threads
</pre></div>

<p>
<b>切换到指定进程</b><br></p>
<div class="highlight"><pre><span></span>(gdb) thread tid
</pre></div>

<p>
<b>向指定的线程发送自定的指令</b><br></p>
<div class="highlight"><pre><span></span>(gdb) thread apply tid/all args
</pre></div>
<p>
常用的指定是查看所有线程的调用堆栈 <code>thread apply all bt</code> ，这个指令与 <code>pstack</code> 命令有些相似。<br></p>

<p>
<b>gdb默认会自动捕捉新产生线程</b><br>
会在产生一个新的线程时会显示出LWP的字样提示用户，LWP = light weight process<br>
可以设置gdb是否提示线程相关的事件<br></p>
<div class="highlight"><pre><span></span>(gdb) set print thread-events on/off
(gdb) show print thread-events
</pre></div>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">为指定的线程设置断点</h2>
<div class="outline-text-2" id="text-2">
<p>
含有多线程的程序，可以为单独的线程设置断点<br></p>
<div class="highlight"><pre><span></span>(gdb) break linespec thread tid
</pre></div>

<p>
任何时候当你的程序在GDB模式下停止的时候，包括当前调试线程的所有线程都会停下来，不会对继续对当前进程造成更改。这时你可以在线程间进行切换，查看整个进程的执行状况。<br></p>
<blockquote>
<p>
Whenever your program stops under GDB for any reason, all threads of execution stop, not just the current thread. This allows you to examine the overall state of the program, including switching between threads, without worrying that things may change underfoot.<br></p>
</blockquote>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">防止gdb自动切换线程</h2>
<div class="outline-text-2" id="text-3">
<p>
在调试gdb程序时，在单步执行时，会出现线程间跳转切换，这样对跟踪代码执行状态十分不方便。<br>
可以通过设置 <code>scheduler-locking</code> 让gdb在所调试的线程中运行，防止线程的自动切换。<br></p>
<div class="highlight"><pre><span></span>(gdb) set scheduler-locking step
</pre></div>
<p>
可以执行以下命令查看当前 <code>scheduler-locking</code> 的设置<br></p>
<div class="highlight"><pre><span></span>(gdb) show scheduler-locking
</pre></div>
<p>
<code>scheduler-locking</code> 有三种模式<br></p>
<ol class="org-ol">
<li>
<code>off</code> 任何线程在任何时候都能执行<br>
</li>
<li>
<code>on</code> 只有当前线程能够执行<br>
</li>
<li>
<code>step</code> 为单步执行优化的模式，比较适合一般的调试<br>
</li>
</ol>
<blockquote>
<p>
Set the scheduler locking mode. If it is off, then there is no locking and any thread may run at any time. If on, then only the current thread may run when the inferior is resumed. The step mode optimizes for single-stepping. It stops other threads from "seizing the prompt" by preempting the current thread while you are stepping. Other threads will only rarely (or never) get a chance to run when you step. They are more likely to run when you `next' over a function call, and they are completely free to run when you use commands like `continue', `until', or `finish'. However, unless another thread hits a breakpoint during its timeslice, they will never steal the GDB prompt away from the thread that you are debugging.<br></p>
</blockquote>
</div>
</div>


<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4">参考资料</h2>
<div class="outline-text-2" id="text-4">
<ol class="org-ol">
<li>
<a href="https://ftp.gnu.org/old-gnu/Manuals/gdb/html_node/gdb_39.html">gnu manual 1</a><br>
</li>
<li>
<a href="https://ftp.gnu.org/old-gnu/Manuals/gdb/html_node/gdb_24.html">gun manual 2</a><br>
</li>
<li>
<a href="https://sourceware.org/gdb/onlinedocs/gdb/Threads.html">sourceware gdb onlinedocs</a><br>
</li>
<li>
<a href="http://www.drdobbs.com/cpp/multithreaded-debugging-techniques/199200938?pgno=1">drdobbs.com</a><br>
</li>
</ol>
</div>
</div>
  </div>
  

</article>
</div>

      <div class="col-sm-3 sidebar">
       
<div class="sidebar-module sidebar-module-inset">
  <h4>About Me</h4>
  
<div class="sidebar-aboutme">
<p>Zeal for coding, C++ developer.</p>
<p>Focus on linux server dev.</p>
<p>I use EMACS, and I am learning python.</p>
<p>View my code on <a href="https://github.com/samsonwang"> Github</a></p>
</div>

</div>

       
<div class="sidebar-module">
  <h4>Categories</h4>
  
<ol class="list-unstyled sidebar-category">
<li>
<a href="/tags/category_cpp/">cpp</a>
</li>
<li>
<a href="/tags/category_emacs/">emacs</a>
</li>
<li>
<a href="/tags/category_linux/">linux</a>
</li>
<li>
<a href="/tags/category_windows/">windows</a>
</li>
</ol>
</div>

      </div>
<!--.sidebar-->
    </div>
<!--.row-->

    

        <ul class="pager hidden-print">
<li class="previous">
                <a href="/posts/gdb-ignore-received-signal/" rel="prev" title="在gdb调试时忽略系统信号（signal）">Previous post</a>
            </li>
            <li class="next">
                <a href="/posts/linux-command-examples-ipcs/" rel="next" title="Linux常用命令行指令 - ipcs">Next post</a>
            </li>
        </ul>
<div class="row">
  <section class="comments hidden-print"><h2>Comments</h2>
    
        
        <div id="disqus_thread"></div>
        <script>
        var disqus_shortname ="samsonwang-me",
            disqus_url="http://samsonwang.me/posts/debug-with-gdb-on-multi-thread-programs/",
        disqus_title="\u4f7f\u7528gdb\u8c03\u8bd5\u591a\u7ebf\u7a0b\u7a0b\u5e8f",
        disqus_identifier="cache/posts/debug-with-gdb-on-multi-thread-programs.html",
        disqus_config = function () {
            this.language = "en";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
    <a href="https://disqus.com" class="dsq-brlink" rel="nofollow">Comments powered by <span class="logo-disqus">Disqus</span></a>


  </section>
</div>

        
       <script>var disqus_shortname="samsonwang-me";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script><!--End of body content--><footer id="footer"><div class="text-center">
<p>Contents © 2017-2018 <a href="mailto:wangzhilv@gmail.com">Samson Wang</a>
 - Powered by <a href="https://getnikola.com/" rel="nofollow">Nikola</a>
 - Hosted on <a href="https://pages.github.com/" rel="nofollow">Github Pages</a>
 - 
<a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/"><img alt="知识共享许可协议" style="border-width:0; vertical-align:text-top;" src="https://i.creativecommons.org/l/by-nc/4.0/80x15.png"></a>
</p>
</div>

      
    </footer>
</div>
</div>

<div id="scroll-top" title="back to top">
  <div id="scroll-top-arrow"></div>
  <div id="scroll-top-stick"></div>
</div>


            <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><script src="https://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js"></script><script src="/assets/js/moment-with-locales.min.js"></script><script src="/assets/js/fancydates.js"></script><script src="/assets/js/jquery.colorbox-min.js"></script><script src="/assets/js/cerulean.js"></script><script>
    $('a.image-reference:not(.islink) img:not(.islink)').parent().colorbox({rel:"gal",maxWidth:"100%",maxHeight:"100%",scalePhotos:true});
  </script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(2, "YYYY-MM-DD HH:mm");
  </script><!-- end fancy dates --><!-- Baidu Analytics --><script>
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?7ec47c52179b8ca4f9aee81282bd7b20";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>
</body>
</html>
