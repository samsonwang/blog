<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#" lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>时间轮算法 | Hack Note</title>
<link href="https://cdn.staticfile.org/twitter-bootstrap/4.1.1/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
<link href="/assets/css/code.css" rel="stylesheet" type="text/css">
<link href="/assets/css/colorbox.css" rel="stylesheet" type="text/css">
<link href="/assets/css/highlight.css" rel="stylesheet" type="text/css">
<link href="/assets/css/cerulean.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="/rss.xml">
<link rel="canonical" href="https://blog.wangzhl.com/posts/timing-wheel-algorithm/">
<link rel="icon" href="/favicon.ico" sizes="64x64">
<!--[if lt IE 9]><script src="https://html5shim.googlecode.com/svn/trunk/html5.js"></script><![endif]--><meta name="author" content="Samson Wang">
<link rel="prev" href="/posts/windows-system32-and-syswow64/" title="Windows平台下System32和SysWOW64文件夹" type="text/html">
</head>
<body class="preload">
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->
<nav id="top-nav" class="navbar navbar-expand-md fixed-top mb-4 navbar-dark bg-dark"><div class="container">   <!-- This keeps the margins nice -->
    <a class="navbar-brand" href="/">

      <span id="blog-title">Hack Note</span>
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="bs-navbar">
      <ul class="navbar-nav ml-auto">
<li class="nav-item">
<a href="/archive/" class="nav-link">Archives</a>
                </li>
<li class="nav-item">
<a href="/tags/" class="nav-link">Tags</a>
                </li>
<li class="nav-item">
<a href="/rss.xml" class="nav-link">RSS Feed</a>

        
      </li>
</ul>
<ul class="navbar-nav navbar-right"></ul>
</div>
<!-- /.navbar-collapse -->
  </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
  <div class="body-content">
    <!--Body content-->
    <div class="row">

      <div class="col-lg-9 col-md-9 col-sm-12 col-xs-12">
        
        
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name">时间轮算法</h1>

    <div class="metadata">
      

      
  <div class="date blur-1">
    <time class="published dt-published" datetime="2020-04-18T09:58:19+08:00" itemprop="datePublished" title="2020-04-18 09:58">Apr 18 2020</time>
</div>

      

      
    <div class="source blur-1">
      <a href="/posts/timing-wheel-algorithm/index.org" class="sourcelink">Source</a>
    </div>

      

      
    <div class="tags blur-2">
    <ul itemprop="keywords">
<li><a class="tag p-category" href="/tags/algorithm/" rel="tag">algorithm</a></li>
        <li><a class="tag p-category" href="/tags/timer/" rel="tag">timer</a></li>
        <li><a class="tag p-category" href="/tags/timing-wheel/" rel="tag">timing wheel</a></li>
    </ul>
</div>

      

    </div>
  </header><div class="e-content entry-content" itemprop="articleBody text">
    <p>
在之前的一篇 <a href="/how-to-impl-a-timer/" class="post-url">文章</a> 中谈到了定时器的基本实现原理，其中提到了几种定时器的调度算法。当需要处理的定时器越来越多时，那些调度策略就不再适合了。本篇文章可以看作是前面文章的拓展，主要展开讲时间轮算法的思路和它的变体。<br></p>

<!-- TEASER_END -->

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">为什么要使用时间轮算法</h2>
<div class="outline-text-2" id="text-1">
<p>
时间轮算法是为了应对定时器的数量越来越多的情况，在待处理定时器的总数达到几千个甚至上万个时，我们希望定时器的性能仍有保证，定时器的性能要从时间复杂度和空间复杂度两方面考虑。<br></p>

<p>
时间复杂度分析主要包括以下几种操作：<br></p>
<ul class="org-ul">
<li>定时器启动：定时器在启动时需要提供超时时间和超时回调函数，并且一般会返回一个用于标识定时器的id。<br>
</li>
<li>定时器取消：定时器在取消时将指定id的定时器移除。<br>
</li>
<li>定时器超时判断：超时判断会有一个检查周期（频率），在每次检查中会找出需要超时触发的定时器。<br>
</li>
</ul>
<p>
空间复杂度指定时器在存储时所消耗的内存，主要受数据结构的影响。<br></p>

<p>
一般来讲，时间复杂度和空间复杂度是紧密联系在一起的，并且鱼和熊掌不可兼得，通常需要牺牲一方面性能换取另一方面性能的提升。很显然，定时器是一个对时间很敏感的功能，在定时器调度策略中，我们在考虑时倾向于牺牲空间复杂度换取时间复杂度。<br></p>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">基础时间轮算法</h2>
<div class="outline-text-2" id="text-2">
<p>
在实现前需要假定所有定时器的超时时间（周期数量）都不会超过某个最大值 <code>N</code> ，这样我们可以用一个容量为N的环形链表存放定时器，每个链表节点对应一个超时时间，将所有超时时间相同的定时器存放在同一个链表节点中。链表中有一个节点代表当前时间 <code>i</code> ，在每次执行检查时将当前时间 <code>i</code> 向前移动移动一个节点变成 <code>i+1</code> 节点， 这样 <code>i+1</code> 节点中的所有定时器就需要超时触发了。在添加一个超时时间为 <code>t</code> 新的定时器时，需要将其放在第 <code>(i+t)%N</code> 个节点中。<br></p>

<p>
举一个简单的例子，如下图所示，假设 <code>N</code> 为8且 <code>i</code> 为1，形象地讲就是最大超时时间为8秒，每一个小格代表1秒。当前时间对应的第1格是第1秒，改节点中所有的定时器在当前时间执行超时回调函数。在下一个检查周期，即第2秒对应的第2格中的所有定时器超时触发，它们的回调函数会被执行。<br></p>

<p>
<img src="/assets/images/spinner.svg" data-src="/images/post-timing-wheel-algorithm-1.png" alt="nil"><br>
配图来源：<a href="https://www.confluent.io/blog/apache-kafka-purgatory-hierarchical-timing-wheels/">confluent.io</a><br></p>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">哈希时间轮算法</h2>
<div class="outline-text-2" id="text-3">
<p>
当最大超时时间很大时，基础时间轮中的节点增多，这样会消耗很多内存。我们可以将相邻的定时器归为一组，将这一组作为一个时间轮节点。每次在定时器超时判断时只需关注当前节点中的那一组定时器。这种方法借鉴了哈希运算的思想，可以看作是一种广义上的哈希运算，就是将变化范围大的对象经过哈希函数映射到一个较小的范围。<br></p>

<p>
当然每个节点中定时器的组织方法可以有很多种，如：不排序的链表、排序的链表、优先队列，这部分的处理策略其实就是一个缩小版定时器调度处理。<br></p>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4">分层时间轮算法</h2>
<div class="outline-text-2" id="text-4">
<p>
分层时间轮算法可以看作是哈希时间轮算法的一个特例，即哈希时间轮中的每个节点中存放的仍然是时间轮。以我们生活中的常见的钟表为例：有24个节点表示小时，每个节点表示1小时；小时节点中有60个分钟节点，每个分钟节点表示1分钟；分钟节点中有60个秒节点，每个秒节点表示1秒。其中的时、分、秒就是将时间轮分为了3个层次。<br></p>
</div>
</div>

<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5">算法演进的思路分析</h2>
<div class="outline-text-2" id="text-5">
<p>
时间轮算法是空间与时间转换的典型案例。为了使每次超时判断处理的速度变快，将定时器按照超时时间分开，这样每次只需要关注那一小部分快要超时的定时器，这是空间换时间。为了减少存储定时器所需要内存，将超时时间接近的放在一个节点中，这是时间换空间。而哈希时间轮节点中仍然是时间轮，这又使用是递归思想。仔细品味算法的设计思路，还真的是蛮有意思的。<br></p>
</div>
</div>

<div id="outline-container-sec-6" class="outline-2">
<h2 id="sec-6">时间轮算法的实现</h2>
<div class="outline-text-2" id="text-6">
<p>
我找了几个时间轮算法的实现代码，不过没有深入研究，等以后有时间的时候再仔细看看：<br></p>
<ul class="org-ul">
<li>
<a href="https://github.com/skywind3000/AsyncNet/blob/master/system/itimer.h">github skywind3000 AsyncNet</a><br>
</li>
<li>
<a href="https://github.com/wahern/timeout">github wahern timeout</a><br>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-7" class="outline-2">
<h2 id="sec-7">参考资料</h2>
<div class="outline-text-2" id="text-7">
<ul class="org-ul">
<li>
<a href="http://www.cs.columbia.edu/~nahum/w6998/papers/sosp87-timing-wheels.pdf">columbia edu - timing wheel</a><br>
</li>
<li>
<a href="https://blog.acolyer.org/2015/11/23/hashed-and-hierarchical-timing-wheels/">acolyer blog - hashed and hierarchical timing wheel</a><br>
</li>
</ul>
<p>
（全文完）<br></p>
</div>
</div>
  </div>
  

</article>
</div>

      <div class="col-lg-3 col-md-3 col-sm-12 col-xs-12 sidebar">
       
<div class="sidebar-module sidebar-module-inset">
  
        <a href="https://github.com/samsonwang">
        <img alt style="padding-bottom:10px;max-width:60%" src="https://avatars3.githubusercontent.com/u/11832311?s=460&amp;v=4"></a>
        <div class="sidebar-aboutme">
        <h4>About Me</h4>
        <p>Zeal for coding, C++ developer. Focused on Linux server develop. I use EMACS on a daily basis.</p>
        </div>
</div>

       
<div class="sidebar-module sidebar-module-inset">
  <h4>Categories</h4>
  
        <ol class="list-unstyled sidebar-category">
<li>
<a href="/tags/category-cpp/">cpp</a>
        </li>
<li>
<a href="/tags/category-emacs/">emacs</a>
        </li>
<li>
<a href="/tags/category-linux/">linux</a>
        </li>
<li>
<a href="/tags/category-windows/">windows</a>
        </li>
</ol>
</div>

      </div>
<!--.sidebar-->
    </div>
<!--.row-->

    

    <ul class="pager hidden-print">
<li class="left">
          <a href="/posts/windows-system32-and-syswow64/" rel="prev">
            <p class="title">Windows平台下System32和SysWOW64文件夹</p>
            <p>Previous post</p>
          </a>
      </li>
      <li class="right">
          <div></div>
      </li>
    </ul>
<section class="comments hidden-print"><h2>Comments</h2>
    
        
        <div id="disqus_thread"></div>
        <script>
        var disqus_shortname ="samsonwang-blog",
            disqus_url="https://blog.wangzhl.com/posts/timing-wheel-algorithm/",
        disqus_title="\u65f6\u95f4\u8f6e\u7b97\u6cd5",
        disqus_identifier="cache/posts/timing-wheel-algorithm.html",
        disqus_config = function () {
            this.language = "en";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
    <a href="https://disqus.com" class="dsq-brlink" rel="nofollow">Comments powered by <span class="logo-disqus">Disqus</span></a>


  </section><script>var disqus_shortname="samsonwang-blog";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script><!--End of body content--><footer id="footer"><div class="text-center">
<p>Contents © 2017-2020 <a href="mailto:wangzhilv@gmail.com">Samson Wang</a>
 - Powered by <a href="https://getnikola.com/" rel="nofollow">Nikola</a>
 - Hosted on <a href="https://pages.github.com/" rel="nofollow">Github Pages</a>
 - 
<a rel="license" href="https://creativecommons.org/licenses/by-nc/4.0/">
<img alt="cc-by-nc 4.0" style="padding-bottom:2px" src="/images/cc-by-nc.png"></a>
</p>
</div>

      
    </footer>
</div>
</div>

<div id="scroll-top" title="back to top">
  <div id="scroll-top-arrow"></div>
  <div id="scroll-top-stick"></div>
</div>


            <script src="https://cdn.staticfile.org/jquery/3.3.1/jquery.min.js"></script><script src="https://cdn.staticfile.org/jquery.colorbox/1.6.4/jquery.colorbox-min.js"></script><script src="https://cdn.staticfile.org/jquery_lazyload/1.9.7/jquery.lazyload.min.js"></script><script src="https://cdn.staticfile.org/popper.js/1.14.3/umd/popper.min.js"></script><script src="https://cdn.staticfile.org/twitter-bootstrap/4.1.1/js/bootstrap.min.js"></script><script src="/assets/js/moment-with-locales.min.js"></script><script src="/assets/js/fancydates.js"></script><script src="/assets/js/cerulean.js"></script><!-- fancy dates --><script>
  moment.locale("en");
  fancydates(0, "YYYY-MM-DD HH:mm");
</script><!-- end fancy dates --><!-- baidu tongji --><script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?1dcffb5494ab56e69005c957d7320ad1";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script><!-- Google Analytics - Global site tag (gtag.js) --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-108507797-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-108507797-1');
</script>
</body>
</html>
